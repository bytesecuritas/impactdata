{% extends 'core/base.html' %}

{% block title %}Liste des Adhérents - Impact Data{% endblock %}

{% block extra_css %}
<style>
    /* Barre de recherche cohérente avec le design du site */
    .search-bar-main {
        background: white;
        border: 2px solid #d1d5db;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
    }
    
    .search-bar-main:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        border-color: #9ca3af;
    }
    
    .filters-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }
    
    .filters-content.show {
        max-height: 2000px;
    }
    
    .filter-section {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1.25rem;
        margin-bottom: 1rem;
    }
    
    .filter-section h6 {
        color: #1a202c;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .filter-section h6 i {
        color: #3182ce;
    }
    
    
    .btn-action {
        width: 32px;
        height: 32px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s ease;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
        <h1 class="h2">
            <i class="fas fa-users"></i> Liste des Adhérents
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            {% if can_create %}
            <a href="{% url 'core:adherent_create' %}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Nouvel adhérent
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Barre de recherche principale -->
    <div class="search-bar-main">
        <form method="get" action="">
            <div class="row g-3 align-items-end">
                <div class="col-md-9">
                    <label class="form-label fw-semibold">
                        <i class="fas fa-search text-primary me-2"></i>Recherche rapide
                    </label>
                    {{ search_form.search }}
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-2"></i>Rechercher
                    </button>
                </div>
            </div>
            
            <!-- Bouton pour afficher/masquer les filtres avancés -->
            <div class="mt-3 d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleFilters()">
                    <i class="fas fa-filter me-2"></i>Filtres avancés
                    <i class="fas fa-chevron-down ms-2" id="filter-icon"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearFilters()">
                    <i class="fas fa-times me-2"></i>Réinitialiser
                </button>
            </div>

            <!-- Filtres avancés (masqués par défaut) -->
            <div class="filters-content mt-3" id="advanced-filters">
                <div class="row">
                    <!-- Type et Organisation -->
                    <div class="col-md-6">
                        <div class="filter-section">
                            <h6><i class="fas fa-building me-2"></i>Organisation & Type</h6>
                            <div class="mb-3">
                                <label class="form-label">{{ search_form.type_adherent.label }}</label>
                                {{ search_form.type_adherent }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{{ search_form.organisation.label }}</label>
                                {{ search_form.organisation }}
                            </div>
                        </div>
                    </div>

                    <!-- Localisation -->
                    <div class="col-md-6">
                        <div class="filter-section">
                            <h6><i class="fas fa-map-marker-alt me-2"></i>Localisation</h6>
                            <div class="mb-3">
                                <label class="form-label">{{ search_form.commune.label }}</label>
                                {{ search_form.commune }}
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">{{ search_form.quartier.label }}</label>
                                        {{ search_form.quartier }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">{{ search_form.secteur.label }}</label>
                                        {{ search_form.secteur }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dates et Badge -->
                    <div class="col-md-6">
                        <div class="filter-section">
                            <h6><i class="fas fa-calendar me-2"></i>Période d'adhésion</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">{{ search_form.join_date_from.label }}</label>
                                        {{ search_form.join_date_from }}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">{{ search_form.join_date_to.label }}</label>
                                        {{ search_form.join_date_to }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Badge et Activité -->
                    <div class="col-md-6">
                        <div class="filter-section">
                            <h6><i class="fas fa-id-card me-2"></i>Badge & Activité</h6>
                            <div class="mb-3">
                                <label class="form-label">{{ search_form.badge_status.label }}</label>
                                {{ search_form.badge_status }}
                            </div>
                            <div class="mb-3">
                                <label class="form-label">{{ search_form.activity_name.label }}</label>
                                {{ search_form.activity_name }}
                            </div>
                        </div>
                    </div>

                    <!-- Créé par -->
                    <div class="col-md-6">
                        <div class="filter-section">
                            <h6><i class="fas fa-user me-2"></i>Créateur</h6>
                            <div class="mb-3">
                                <label class="form-label">{{ search_form.created_by.label }}</label>
                                {{ search_form.created_by }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-end mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-filter me-2"></i>Appliquer les filtres
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stats-card-professional">
                <div class="icon-container primary">
                    <i class="fas fa-users"></i>
                </div>
                <h3>{{ total_count }}</h3>
                <p>Adhérents trouvés</p>
            </div>
        </div>
    </div>

    <!-- Liste des adhérents -->
    <div class="table-card-professional">
        <div class="card-header">
            <h5>
                <i class="fas fa-list me-2"></i>Résultats ({{ adherents|length }} / {{ total_count }})
            </h5>
        </div>
        <div class="card-body p-0">
            {% if adherents %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 120px;">Actions</th>
                                <th>Identifiant</th>
                                <th>Nom complet</th>
                                <th>Contact</th>
                                <th>Localisation</th>
                                <th>Type</th>
                                <th>Organisation</th>
                                <th>Badge</th>
                                <th>Adhésion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for adherent in adherents %}
                            <tr>
                                <!-- Actions -->
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'core:adherent_detail' adherent.id %}" 
                                           class="btn btn-action btn-outline-primary" title="Voir détails">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if can_edit %}
                                        <a href="{% url 'core:adherent_update' adherent.id %}" 
                                           class="btn btn-action btn-outline-warning" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        {% endif %}
                                        {% if can_delete %}
                                        <a href="{% url 'core:adherent_delete' adherent.id %}" 
                                           class="btn btn-action btn-outline-danger" title="Supprimer"
                                           onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet adhérent ?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                        {% endif %}
                                    </div>
                                </td>

                                <!-- Identifiant -->
                                <td><strong class="text-primary">{{ adherent.identifiant }}</strong></td>

                                <!-- Nom complet + photo -->
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if adherent.profile_picture %}
                                            <img src="{{ adherent.profile_picture.url }}" 
                                                 class="rounded-circle me-2" 
                                                 width="40" height="40" 
                                                 alt="{{ adherent.full_name }}">
                                        {% else %}
                                            <div class="rounded-circle me-2 d-flex align-items-center justify-content-center bg-secondary" 
                                                 style="width: 40px; height: 40px;">
                                                <i class="fas fa-user text-white"></i>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <strong>{{ adherent.full_name }}</strong>
                                            {% if adherent.birth_date %}
                                            <br><small class="text-muted">({{ adherent.get_age }} ans)</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>

                                <!-- Contact -->
                                <td>
                                    <i class="fas fa-phone text-primary me-1"></i>{{ adherent.phone1 }}
                                    {% if adherent.email %}
                                        <br><i class="fas fa-envelope text-muted me-1"></i><small class="text-muted">{{ adherent.email }}</small>
                                    {% endif %}
                                </td>

                                <!-- Localisation -->
                                <td>
                                    <strong>{{ adherent.commune }}</strong>
                                    <br><small class="text-muted">{{ adherent.quartier }}, {{ adherent.secteur }}</small>
                                </td>

                                <!-- Type d'adhérent -->
                                <td>
                                    <span class="badge {% if adherent.type_adherent == 'physical' %}bg-primary{% else %}bg-info{% endif %}">
                                        {{ adherent.get_type_adherent_display }}
                                    </span>
                                </td>

                                <!-- Organisation -->
                                <td>
                                    <strong>{{ adherent.organisation.name }}</strong>
                                    {% if adherent.organisation.category %}
                                    <br><small class="text-muted">{{ adherent.organisation.category.name }}</small>
                                    {% endif %}
                                </td>

                                <!-- Badge -->
                                <td>
                                    {% if adherent.is_badge_valid %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Valide
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times-circle me-1"></i>Expiré
                                        </span>
                                    {% endif %}
                                    {% if adherent.badge_validity %}
                                    <br><small class="text-muted">{{ adherent.badge_validity|date:"d/m/Y" }}</small>
                                    {% endif %}
                                </td>

                                <!-- Date d'adhésion -->
                                <td>
                                    {{ adherent.join_date|date:"d/m/Y" }}
                                    <br><small class="text-muted">{{ adherent.get_age_membership }} jour(s)</small>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if page_obj.has_other_pages %}
                <div class="p-3">
                    <nav aria-label="Pagination">
                        <ul class="pagination justify-content-center mb-0">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
                {% endif %}
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Aucun adhérent trouvé</h5>
                    <p class="text-muted">Aucun adhérent ne correspond aux critères de recherche.</p>
                    {% if can_create %}
                    <a href="{% url 'core:adherent_create' %}" class="btn btn-primary mt-3">
                        <i class="fas fa-user-plus me-2"></i>Ajouter un adhérent
                    </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Toggle filtres avancés
function toggleFilters() {
    const filters = document.getElementById('advanced-filters');
    const icon = document.getElementById('filter-icon');
    
    if (filters.classList.contains('show')) {
        filters.classList.remove('show');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    } else {
        filters.classList.add('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    }
}

// Réinitialiser les filtres
function clearFilters() {
    window.location.href = '{% url "core:adherent_list" %}';
}

// Ouvrir automatiquement les filtres si des paramètres sont présents
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    let hasFilters = false;
    
    for (const [key, value] of urlParams) {
        if (key !== 'page' && value) {
            hasFilters = true;
            break;
        }
    }
    
    if (hasFilters) {
        toggleFilters();
    }
});
</script>
{% endblock %}
