{% extends 'core/base.html' %}
{% load static %}

{% block title %}Test Final - Searchable Select{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Test Final - Champs Select avec Recherche</h1>
    
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Test Personnel (avec API r√©elle)</label>
                <div class="searchable-select-container">
                    <select class="form-select searchable-select" data-search-url="/api/personnel/search/" data-search-fields="matricule,first_name,last_name" data-placeholder="Rechercher par matricule...">
                        <option value="">Rechercher par matricule...</option>
                    </select>
                    <div class="search-overlay">
                        <input type="text" class="form-control search-input" placeholder="Rechercher par matricule..." autocomplete="off">
                        <div class="search-results"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label class="form-label">Test Adh√©rent (avec API r√©elle)</label>
                <div class="searchable-select-container">
                    <select class="form-select searchable-select" data-search-url="/api/adherent/search/" data-search-fields="id,identifiant,phone1,phone2,first_name,last_name" data-placeholder="Rechercher par ID, t√©l√©phone...">
                        <option value="">Rechercher par ID, t√©l√©phone...</option>
                    </select>
                    <div class="search-overlay">
                        <input type="text" class="form-control search-input" placeholder="Rechercher par ID, t√©l√©phone..." autocomplete="off">
                        <div class="search-results"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mt-4">
        <h3>Instructions :</h3>
        <ol>
            <li><strong>Cliquez</strong> sur un champ select</li>
            <li><strong>Tapez</strong> du texte (ex: "AG" ou "625")</li>
            <li><strong>V√©rifiez</strong> les logs dans la console (F12)</li>
            <li><strong>V√©rifiez</strong> que les APIs sont appel√©es</li>
        </ol>
    </div>
    
    <div class="mt-4">
        <h3>R√©sultat :</h3>
        <p id="result">Aucune s√©lection</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîç Test final - Initialisation...');
    
    const searchableSelects = document.querySelectorAll('.searchable-select');
    console.log(`üìã Trouv√© ${searchableSelects.length} champs select`);
    
    searchableSelects.forEach((select, index) => {
        console.log(`üîß Initialisation du champ ${index + 1}`);
        initSearchableSelect(select);
    });
});

function initSearchableSelect(selectElement) {
    const container = selectElement.closest('.searchable-select-container');
    const searchOverlay = container.querySelector('.search-overlay');
    const searchInput = searchOverlay.querySelector('.search-input');
    const resultsContainer = searchOverlay.querySelector('.search-results');
    const searchUrl = selectElement.dataset.searchUrl;
    
    console.log('‚úÖ √âl√©ments trouv√©s:', {
        container: !!container,
        searchOverlay: !!searchOverlay,
        searchInput: !!searchInput,
        resultsContainer: !!resultsContainer,
        searchUrl: searchUrl
    });
    
    // √âv√©nement sur le select
    selectElement.addEventListener('click', function(e) {
        console.log('üñ±Ô∏è Clic sur le select');
        e.preventDefault();
        showSearch();
    });
    
    // √âv√©nement sur l'input
    searchInput.addEventListener('input', function(e) {
        console.log('‚å®Ô∏è Saisie:', e.target.value);
        handleSearch(e.target.value);
    });
    
    // Fermer en cliquant ailleurs
    document.addEventListener('click', function(e) {
        if (!container.contains(e.target)) {
            hideSearch();
        }
    });
    
    function showSearch() {
        console.log('üëÅÔ∏è Affichage de la recherche');
        searchOverlay.style.display = 'block';
        setTimeout(function() {
            searchInput.focus();
            searchInput.value = '';
        }, 10);
        resultsContainer.innerHTML = '';
    }
    
    function hideSearch() {
        console.log('üôà Masquage de la recherche');
        searchOverlay.style.display = 'none';
    }
    
    async function handleSearch(query) {
        if (query.length < 2) {
            resultsContainer.innerHTML = '';
            return;
        }
        
        console.log('üîç Recherche:', query);
        
        try {
            // Corriger l'URL pour inclure le pr√©fixe /core/
            const fullUrl = searchUrl.startsWith('/') ? searchUrl : `/core${searchUrl}`;
            console.log('üîó URL compl√®te:', fullUrl);
            
            const response = await fetch(`${fullUrl}?q=${encodeURIComponent(query)}`);
            console.log('üì° R√©ponse:', response.status, response.statusText);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üìä R√©sultats:', data);
            displayResults(data.results);
        } catch (error) {
            console.error('‚ùå Erreur lors de la recherche:', error);
            resultsContainer.innerHTML = `<div class="search-error">Erreur: ${error.message}</div>`;
        }
    }
    
    function displayResults(results) {
        if (results.length === 0) {
            resultsContainer.innerHTML = '<div class="search-no-results">Aucun r√©sultat trouv√©</div>';
            return;
        }
        
        console.log('üìã Affichage de', results.length, 'r√©sultats');
        
        const resultsHtml = results.map(result => `
            <div class="search-result-item" data-value="${result.id}" data-text="${result.text}">
                <div class="result-text">${result.text}</div>
                ${result.matricule ? `<div class="result-matricule">Matricule: ${result.matricule}</div>` : ''}
                ${result.phone ? `<div class="result-phone">T√©l: ${result.phone}</div>` : ''}
            </div>
        `).join('');
        
        resultsContainer.innerHTML = resultsHtml;
        
        // √âv√©nements sur les r√©sultats
        resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', function() {
                console.log('‚úÖ S√©lection:', item.dataset.text);
                selectResult(item);
            });
        });
    }
    
    function selectResult(resultItem) {
        const value = resultItem.dataset.value;
        const text = resultItem.dataset.text;
        
        selectElement.value = value;
        document.getElementById('result').textContent = `S√©lectionn√©: ${text}`;
        hideSearch();
    }
}
</script>
{% endblock %}
