<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Searchable Select</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .searchable-select-container {
            position: relative;
        }

        .searchable-select-container .searchable-select {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-right: 2.5rem;
        }

        .search-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            z-index: 9999;
            display: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .search-overlay .search-input {
            width: 100%;
            border: none;
            outline: none;
            padding: 0.5rem 0.75rem;
            font-size: 1rem;
            border-radius: 0.375rem;
            background: transparent;
            position: relative;
            z-index: 10000;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            max-height: 200px;
            overflow-y: auto;
            z-index: 10002;
        }

        .search-result-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
            border-left: 3px solid #3182ce;
        }

        .search-error {
            color: #dc3545;
            padding: 0.5rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1>Test Final - Champs Select avec Recherche</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Test Personnel (avec API r√©elle)</label>
                    <div class="searchable-select-container">
                        <select class="form-select searchable-select" data-search-url="/api/personnel/search/" data-search-fields="matricule,first_name,last_name" data-placeholder="Rechercher par matricule...">
                            <option value="">Rechercher par matricule...</option>
                        </select>
                        <div class="search-overlay">
                            <input type="text" class="form-control search-input" placeholder="Rechercher par matricule..." autocomplete="off">
                            <div class="search-results"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label">Test Adh√©rent (avec API r√©elle)</label>
                    <div class="searchable-select-container">
                        <select class="form-select searchable-select" data-search-url="/api/adherent/search/" data-search-fields="id,identifiant,phone1,phone2,first_name,last_name" data-placeholder="Rechercher par ID, t√©l√©phone...">
                            <option value="">Rechercher par ID, t√©l√©phone...</option>
                        </select>
                        <div class="search-overlay">
                            <input type="text" class="form-control search-input" placeholder="Rechercher par ID, t√©l√©phone..." autocomplete="off">
                            <div class="search-results"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-4">
            <h3>Instructions :</h3>
            <ol>
                <li><strong>Cliquez</strong> sur un champ select</li>
                <li><strong>Tapez</strong> du texte (ex: "AG" ou "625")</li>
                <li><strong>V√©rifiez</strong> les logs dans la console (F12)</li>
                <li><strong>V√©rifiez</strong> que les APIs sont appel√©es</li>
            </ol>
        </div>
        
        <div class="mt-4">
            <h3>R√©sultat :</h3>
            <p id="result">Aucune s√©lection</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç Test final - Initialisation...');
            
            const searchableSelects = document.querySelectorAll('.searchable-select');
            console.log(`üìã Trouv√© ${searchableSelects.length} champs select`);
            
            searchableSelects.forEach((select, index) => {
                console.log(`üîß Initialisation du champ ${index + 1}`);
                initSearchableSelect(select);
            });
        });

        function initSearchableSelect(selectElement) {
            const container = selectElement.closest('.searchable-select-container');
            const searchOverlay = container.querySelector('.search-overlay');
            const searchInput = searchOverlay.querySelector('.search-input');
            const resultsContainer = searchOverlay.querySelector('.search-results');
            const searchUrl = selectElement.dataset.searchUrl;
            
            console.log('‚úÖ √âl√©ments trouv√©s:', {
                container: !!container,
                searchOverlay: !!searchOverlay,
                searchInput: !!searchInput,
                resultsContainer: !!resultsContainer,
                searchUrl: searchUrl
            });
            
            // √âv√©nement sur le select
            selectElement.addEventListener('click', function(e) {
                console.log('üñ±Ô∏è Clic sur le select');
                e.preventDefault();
                showSearch();
            });
            
            // √âv√©nement sur l'input
            searchInput.addEventListener('input', function(e) {
                console.log('‚å®Ô∏è Saisie:', e.target.value);
                handleSearch(e.target.value);
            });
            
            // Fermer en cliquant ailleurs
            document.addEventListener('click', function(e) {
                if (!container.contains(e.target)) {
                    hideSearch();
                }
            });
            
            function showSearch() {
                console.log('üëÅÔ∏è Affichage de la recherche');
                searchOverlay.style.display = 'block';
                setTimeout(function() {
                    searchInput.focus();
                    searchInput.value = '';
                }, 10);
                resultsContainer.innerHTML = '';
            }
            
            function hideSearch() {
                console.log('üôà Masquage de la recherche');
                searchOverlay.style.display = 'none';
            }
            
            async function handleSearch(query) {
                if (query.length < 2) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                console.log('üîç Recherche:', query);
                
                try {
                    // Corriger l'URL pour inclure le pr√©fixe /core/
                    const fullUrl = searchUrl.startsWith('/') ? searchUrl : `/core${searchUrl}`;
                    console.log('üîó URL compl√®te:', fullUrl);
                    
                    const response = await fetch(`${fullUrl}?q=${encodeURIComponent(query)}`);
                    console.log('üì° R√©ponse:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('üìä R√©sultats:', data);
                    displayResults(data.results);
                } catch (error) {
                    console.error('‚ùå Erreur lors de la recherche:', error);
                    resultsContainer.innerHTML = `<div class="search-error">Erreur: ${error.message}</div>`;
                }
            }
            
            function displayResults(results) {
                if (results.length === 0) {
                    resultsContainer.innerHTML = '<div class="search-no-results">Aucun r√©sultat trouv√©</div>';
                    return;
                }
                
                console.log('üìã Affichage de', results.length, 'r√©sultats');
                
                const resultsHtml = results.map(result => `
                    <div class="search-result-item" data-value="${result.id}" data-text="${result.text}">
                        <div class="result-text">${result.text}</div>
                        ${result.matricule ? `<div class="result-matricule">Matricule: ${result.matricule}</div>` : ''}
                        ${result.phone ? `<div class="result-phone">T√©l: ${result.phone}</div>` : ''}
                    </div>
                `).join('');
                
                resultsContainer.innerHTML = resultsHtml;
                
                // √âv√©nements sur les r√©sultats
                resultsContainer.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', function() {
                        console.log('‚úÖ S√©lection:', item.dataset.text);
                        selectResult(item);
                    });
                });
            }
            
            function selectResult(resultItem) {
                const value = resultItem.dataset.value;
                const text = resultItem.dataset.text;
                
                selectElement.value = value;
                document.getElementById('result').textContent = `S√©lectionn√©: ${text}`;
                hideSearch();
            }
        }
    </script>
</body>
</html>
